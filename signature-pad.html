<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Signature Pad</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg-a: #1b2436;
      --bg-b: #0e141f;
      --panel: rgba(16, 22, 34, 0.92);
      --panel-edge: rgba(120, 146, 198, 0.3);
      --ink: #e8eefc;
      --muted: #b8c5de;
      --accent: #2d5bde;
      --accent-deep: #1f46b8;
    }

    * { box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
    }

    body {
      margin: 0;
      display: grid;
      place-items: stretch;
      font-family: "Roboto Condensed", "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top, var(--bg-a), var(--bg-b));
      color: var(--ink);
      overflow: hidden;
      overscroll-behavior: none;
      touch-action: none;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .pad-card {
      width: 100vw;
      height: 100vh;
      background: linear-gradient(160deg, rgba(24, 32, 48, 0.96), var(--panel));
      border: none;
      border-radius: 0;
      padding: 16px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 12px;
    }

    .pad-header {
      display: grid;
      gap: 8px;
    }

    h1 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #dbe7ff;
    }

    #status {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .mode-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .mode-controls label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(120, 146, 198, 0.35);
      background: rgba(16, 22, 34, 0.6);
    }

    .mode-controls input {
      width: 14px;
      height: 14px;
      margin: 0;
    }

    .pad-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 240px;
      gap: 12px;
      height: 100%;
      min-height: 0;
    }

    .pad-wrap {
      border-radius: 14px;
      border: 1px solid rgba(140, 165, 210, 0.4);
      background: #fff;
      padding: 8px;
      display: grid;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 10px;
      background: #fff;
      touch-action: none;
    }

    .actions {
      display: grid;
      grid-auto-rows: min-content;
      gap: 10px;
      align-content: start;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      font: 700 0.78rem "Roboto Condensed", sans-serif;
      letter-spacing: 0.04em;
      color: #fff;
      background: linear-gradient(160deg, var(--accent), var(--accent-deep));
      cursor: pointer;
      box-shadow: 0 10px 16px rgba(33, 74, 190, 0.28);
    }

    button.secondary {
      background: linear-gradient(160deg, #58647c, #424d61);
      box-shadow: 0 8px 14px rgba(35, 46, 70, 0.35);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    @media (orientation: portrait) {
      .pad-card {
        padding: 14px;
      }

      .pad-layout {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }

      .actions {
        grid-auto-flow: column;
        grid-auto-columns: 1fr;
      }
    }

    body.force-portrait .pad-layout {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr auto;
    }

    body.force-portrait .actions {
      grid-auto-flow: column;
      grid-auto-columns: 1fr;
    }

    body.force-landscape .pad-layout {
      grid-template-columns: minmax(0, 1fr) 240px;
      grid-template-rows: none;
    }
  </style>
</head>
<body>
  <main class="pad-card">
    <div class="pad-header">
      <h1>Signature Pad</h1>
      <p id="status">Loading...</p>
      <div class="mode-controls" aria-label="Signature pad orientation">
        <label>
          <input id="modeLandscape" type="checkbox" />
          Landscape
        </label>
        <label>
          <input id="modePortrait" type="checkbox" />
          Portrait
        </label>
      </div>
    </div>
    <div class="pad-layout">
      <div class="pad-wrap">
        <canvas id="signaturePad" aria-label="Signature drawing pad"></canvas>
      </div>
      <div class="actions">
        <button id="clearPad" class="secondary" type="button">Clear</button>
        <button id="submitPad" type="button">Approve Signature</button>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseProjectUrl = "https://pboqhiwhkqfitxvbzbxt.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBib3FoaXdoa3FmaXR4dmJ6Ynh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDI4MzgsImV4cCI6MjA4NzU3ODgzOH0.H9DjOQmSop9e6O_z0uZgBNT2-WtuE4DJc4o1gFMs1do";
    const client = window.supabase
      ? window.supabase.createClient(supabaseProjectUrl, supabaseAnonKey, {
          auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
        })
      : null;

    const statusEl = document.getElementById("status");
    const pad = document.getElementById("signaturePad");
    const clearBtn = document.getElementById("clearPad");
    const submitBtn = document.getElementById("submitPad");
    const landscapeToggle = document.getElementById("modeLandscape");
    const portraitToggle = document.getElementById("modePortrait");
    const token = "shared";

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.style.color = isError ? "#ffb0b0" : "#b8c5de";
    }

    if (!client) {
      setStatus("Supabase client unavailable.", true);
    } else {
      setStatus("Draw your signature, then approve.");
    }

    const ctx = pad.getContext("2d");
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    ctx.lineWidth = 5;
    ctx.strokeStyle = "#111";
    let drawing = false;
    let hasInk = false;

    let forcedMode = "landscape";
    const orientationQuery = window.matchMedia("(orientation: portrait)");

    function getAutoMode() {
      return orientationQuery.matches ? "portrait" : "landscape";
    }

    function updateModeToggles() {
      const mode = forcedMode === "auto" ? getAutoMode() : forcedMode;
      if (landscapeToggle) landscapeToggle.checked = mode === "landscape";
      if (portraitToggle) portraitToggle.checked = mode === "portrait";
    }

    function applyMode(mode) {
      forcedMode = mode;
      document.body.classList.toggle("force-landscape", mode === "landscape");
      document.body.classList.toggle("force-portrait", mode === "portrait");
      applyMode("landscape");
      requestAnimationFrame(resizeCanvas);
    }

    function resizeCanvas() {
      if (!pad) return;
      const rect = pad.getBoundingClientRect();
      const prev = hasInk ? pad.toDataURL("image/png") : null;
      const ratio = Math.max(1, window.devicePixelRatio || 1);
      pad.width = Math.max(1, Math.floor(rect.width * ratio));
      pad.height = Math.max(1, Math.floor(rect.height * ratio));
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.lineWidth = 5;
      ctx.strokeStyle = "#111";
      if (prev) {
        const img = new Image();
        img.onload = () => {
          ctx.drawImage(img, 0, 0, rect.width, rect.height);
        };
        img.src = prev;
      }
    }

    function getPoint(evt) {
      const rect = pad.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;
      return { x, y };
    }

    function startDraw(evt) {
      if (!token) return;
      drawing = true;
      const { x, y } = getPoint(evt);
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function draw(evt) {
      if (!drawing) return;
      const { x, y } = getPoint(evt);
      ctx.lineTo(x, y);
      ctx.stroke();
      hasInk = true;
    }

    function endDraw() {
      drawing = false;
    }

    pad.addEventListener("pointerdown", (evt) => {
      evt.preventDefault();
      startDraw(evt);
    });
    pad.addEventListener("pointermove", (evt) => {
      evt.preventDefault();
      draw(evt);
    });
    pad.addEventListener("pointerup", endDraw);
    pad.addEventListener("pointerleave", endDraw);
    pad.addEventListener("pointercancel", endDraw);

    if (landscapeToggle) {
      landscapeToggle.addEventListener("change", () => {
        if (landscapeToggle.checked) {
          if (portraitToggle) portraitToggle.checked = false;
          applyMode("landscape");
        } else {
          applyMode("auto");
        }
      });
    }

    if (portraitToggle) {
      portraitToggle.addEventListener("change", () => {
        if (portraitToggle.checked) {
          if (landscapeToggle) landscapeToggle.checked = false;
          applyMode("portrait");
        } else {
          applyMode("auto");
        }
      });
    }

    if (orientationQuery) {
      orientationQuery.addEventListener("change", () => {
        if (forcedMode === "auto") {
          applyMode("landscape");
          requestAnimationFrame(resizeCanvas);
        }
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        ctx.clearRect(0, 0, pad.width, pad.height);
        hasInk = false;
      });
    }

    if (submitBtn) {
      submitBtn.addEventListener("click", async () => {
        if (!client) return;
        if (!hasInk) {
          setStatus("Draw your signature first.", true);
          return;
        }
        submitBtn.disabled = true;
        const now = new Date().toISOString();
        const dataUrl = pad.toDataURL("image/png");
        try {
          const { data, error } = await client
            .from("signature_requests")
            .upsert({ token, signature_data: dataUrl, used_at: now }, { onConflict: "token" })
            .eq("token", token)
            .is("used_at", null)
            .select("token");
          if (error) throw error;
          if (!data || !data.length) {
            setStatus("Token expired or already used.", true);
            submitBtn.disabled = false;
            return;
          }
          setStatus("Signature submitted. You can close this page.");
          submitBtn.disabled = true;
          if (clearBtn) clearBtn.disabled = true;
        } catch (err) {
          setStatus(`Submit failed: ${err.message || err}`, true);
          submitBtn.disabled = false;
        }
      });
    }

    applyMode("landscape");
    window.addEventListener("resize", () => requestAnimationFrame(resizeCanvas));
    window.addEventListener("orientationchange", () => requestAnimationFrame(resizeCanvas));
    requestAnimationFrame(resizeCanvas);
  </script>
</body>
</html>
