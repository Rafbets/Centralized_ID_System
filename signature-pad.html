<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Signature Pad</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      font-family: "Roboto Condensed", "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top, #1b2436, #0e141f);
      color: #e8eefc;
      padding: 18px;
      overflow: hidden;
      overscroll-behavior: none;
      touch-action: none;
    }

    .pad-card {
      width: min(540px, 94vw);
      background: linear-gradient(160deg, rgba(24, 32, 48, 0.95), rgba(16, 22, 34, 0.9));
      border: 1px solid rgba(120, 146, 198, 0.3);
      border-radius: 16px;
      padding: 16px;
      display: grid;
      gap: 12px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
    }

    h1 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #dbe7ff;
    }

    #status {
      margin: 0;
      font-size: 0.85rem;
      color: #b8c5de;
    }

    .pad-wrap {
      border-radius: 12px;
      border: 1px solid rgba(140, 165, 210, 0.4);
      background: #fff;
      padding: 6px;
    }

    canvas {
      width: 100%;
      height: 180px;
      display: block;
      border-radius: 10px;
      background: #fff;
    }

    @media (max-width: 720px) {
      body {
        padding: 0;
      }

      .pad-card {
        width: 100vw;
        height: 100vh;
        border-radius: 0;
        border: none;
        box-shadow: none;
        padding: 16px;
      }

      .pad-wrap {
        flex: 1;
      }

      canvas {
        height: calc(100vh - 240px);
        max-height: 60vh;
      }
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font: 700 0.78rem "Roboto Condensed", sans-serif;
      letter-spacing: 0.04em;
      color: #fff;
      background: linear-gradient(160deg, #2d5bde, #1f46b8);
      cursor: pointer;
      box-shadow: 0 10px 16px rgba(33, 74, 190, 0.28);
    }

    button.secondary {
      background: linear-gradient(160deg, #58647c, #424d61);
      box-shadow: 0 8px 14px rgba(35, 46, 70, 0.35);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <main class="pad-card">
    <h1>Signature Pad</h1>
    <p id="status">Loading...</p>
    <div class="pad-wrap">
      <canvas id="signaturePad" width="520" height="180" aria-label="Signature drawing pad"></canvas>
    </div>
    <div class="actions">
      <button id="clearPad" class="secondary" type="button">Clear</button>
      <button id="submitPad" type="button">Approve Signature</button>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseProjectUrl = "https://pboqhiwhkqfitxvbzbxt.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBib3FoaXdoa3FmaXR4dmJ6Ynh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDI4MzgsImV4cCI6MjA4NzU3ODgzOH0.H9DjOQmSop9e6O_z0uZgBNT2-WtuE4DJc4o1gFMs1do";
    const client = window.supabase
      ? window.supabase.createClient(supabaseProjectUrl, supabaseAnonKey, {
          auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
        })
      : null;

    const statusEl = document.getElementById("status");
    const pad = document.getElementById("signaturePad");
    const clearBtn = document.getElementById("clearPad");
    const submitBtn = document.getElementById("submitPad");
    const params = new URLSearchParams(window.location.search);
    const token = (params.get("t") || params.get("token") || "").trim();

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.style.color = isError ? "#ffb0b0" : "#b8c5de";
    }

    if (!token) {
      setStatus("Missing or invalid token.", true);
    } else if (!client) {
      setStatus("Supabase client unavailable.", true);
    } else {
      setStatus("Draw your signature, then approve.");
    }

    const ctx = pad.getContext("2d");
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    ctx.lineWidth = 3;
    ctx.strokeStyle = "#111";
    let drawing = false;
    let hasInk = false;

    function getPoint(evt) {
      const rect = pad.getBoundingClientRect();
      const x = ((evt.clientX - rect.left) * pad.width) / rect.width;
      const y = ((evt.clientY - rect.top) * pad.height) / rect.height;
      return { x, y };
    }

    function startDraw(evt) {
      if (!token) return;
      drawing = true;
      const { x, y } = getPoint(evt);
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function draw(evt) {
      if (!drawing) return;
      const { x, y } = getPoint(evt);
      ctx.lineTo(x, y);
      ctx.stroke();
      hasInk = true;
    }

    function endDraw() {
      drawing = false;
    }

    pad.addEventListener("pointerdown", (evt) => {
      evt.preventDefault();
      startDraw(evt);
    });
    pad.addEventListener("pointermove", (evt) => {
      evt.preventDefault();
      draw(evt);
    });
    pad.addEventListener("pointerup", endDraw);
    pad.addEventListener("pointerleave", endDraw);
    pad.addEventListener("pointercancel", endDraw);

    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        ctx.clearRect(0, 0, pad.width, pad.height);
        hasInk = false;
      });
    }

    if (submitBtn) {
      submitBtn.addEventListener("click", async () => {
        if (!client || !token) return;
        if (!hasInk) {
          setStatus("Draw your signature first.", true);
          return;
        }
        submitBtn.disabled = true;
        const now = new Date().toISOString();
        const dataUrl = pad.toDataURL("image/png");
        try {
          const { data, error } = await client
            .from("signature_requests")
            .update({ signature_data: dataUrl, used_at: now })
            .eq("token", token)
            .is("used_at", null)
            .select("token");
          if (error) throw error;
          if (!data || !data.length) {
            setStatus("Token expired or already used.", true);
            submitBtn.disabled = false;
            return;
          }
          setStatus("Signature submitted. You can close this page.");
          submitBtn.disabled = true;
          if (clearBtn) clearBtn.disabled = true;
        } catch (err) {
          setStatus(`Submit failed: ${err.message || err}`, true);
          submitBtn.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
